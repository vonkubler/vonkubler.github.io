<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Grammar Practice</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer shadow */
            padding: 2.5rem; /* More padding */
            width: 100%;
            max-width: 800px; /* Max width for readability */
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded buttons */
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo on hover */
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #e0e7ff; /* Light indigo */
            color: #4f46e5; /* Indigo text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #4f46e5;
        }
        .btn-secondary:hover {
            background-color: #c7d2fe; /* Lighter indigo on hover */
            transform: translateY(-2px);
        }
        .input-field {
            border: 2px solid #cbd5e1; /* Slate border */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo focus */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .feedback-correct {
            color: #10b981; /* Green */
            font-weight: 600;
        }
        .feedback-incorrect {
            color: #ef4444; /* Red */
            font-weight: 600;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">ESL Grammar Practice</h1>

        <!-- Topic Selection -->
        <div class="mb-8">
            <label for="topic-select" class="block text-lg font-semibold text-gray-700 mb-2">Choose a Grammar Topic:</label>
            <select id="topic-select" class="input-field">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>

        <!-- Grammar Explanation Section -->
        <div id="explanation-section" class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <h2 class="text-2xl font-semibold text-blue-800 mb-4">Grammar Explanation: <span id="explanation-topic-title"></span></h2>
            <div id="grammar-explanation" class="text-gray-700 leading-relaxed">
                <!-- Explanation content will be loaded here -->
            </div>
            <button id="start-exercise-btn" class="btn-primary mt-6">Start Exercise</button>
        </div>

        <!-- Exercise Section -->
        <div id="exercise-section" class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg hidden">
            <h2 class="text-2xl font-semibold text-green-800 mb-4">Practice Exercise: <span id="exercise-topic-title"></span></h2>
            <div id="exercise-content" class="text-gray-700 leading-relaxed mb-4">
                <!-- Exercise content will be loaded here -->
            </div>
            <div id="exercise-input-area" class="mb-4">
                <!-- Input fields for exercises -->
            </div>
            <div id="feedback" class="text-lg font-semibold mb-4">
                <!-- Feedback will be displayed here -->
            </div>
            <div class="flex space-x-4">
                <button id="check-answer-btn" class="btn-primary">Check Answer</button>
                <button id="next-exercise-btn" class="btn-secondary hidden">Next Exercise</button>
                <button id="back-to-topics-btn" class="btn-secondary hidden">Back to Topics</button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center text-gray-600 hidden mt-8">
            <div class="loading-spinner"></div>
            <span class="ml-2">Loading content...</span>
        </div>

        <!-- Message Box for alerts -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="message-content" class="text-lg font-semibold text-gray-800 mb-6"></p>
                <button id="message-ok-btn" class="btn-primary">OK</button>
            </div>
        </div>

    </div>

    <script>
        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Message box utility
        function showMessageBox(message) {
            const messageBox = document.getElementById('message-box');
            const messageContent = document.getElementById('message-content');
            const messageOkBtn = document.getElementById('message-ok-btn');

            messageContent.textContent = message;
            messageBox.classList.remove('hidden');

            return new Promise(resolve => {
                messageOkBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    resolve();
                };
            });
        }

        // Grammar Topics and their LLM prompts
        const grammarTopics = [
            {
                name: "Present Simple",
                explanationPrompt: "Explain the Present Simple tense in English for adult ESL learners, including its uses, forms (affirmative, negative, interrogative), and common time expressions. Provide simple, clear examples.",
                exercisePrompt: "Generate 5 fill-in-the-blanks sentences for adult ESL learners to practice the Present Simple tense. For each sentence, provide the correct conjugated verb in the parentheses. Example: 'She ___ (plays) tennis every Sunday.'",
                type: "fill-in-the-blanks"
            },
            {
                name: "Past Simple",
                explanationPrompt: "Explain the Past Simple tense in English for adult ESL learners, covering regular and irregular verbs, uses, forms (affirmative, negative, interrogative), and common time expressions. Provide clear examples.",
                exercisePrompt: "Generate 5 fill-in-the-blanks sentences for adult ESL learners to practice the Past Simple tense. For each sentence, provide the correct conjugated verb in the parentheses. Example: 'They ___ (visited) Paris last year.'",
                type: "fill-in-the-blanks"
            },
            {
                name: "Present Perfect",
                explanationPrompt: "Explain the Present Perfect tense in English for adult ESL learners, including its uses (experience, unfinished actions, recent events), forms (have/has + past participle), and common time expressions (e.g., 'since', 'for', 'already', 'yet'). Provide clear examples.",
                exercisePrompt: "Generate 5 fill-in-the-blanks sentences for adult ESL learners to practice the Present Perfect tense. For each sentence, provide the correct conjugated verb in the parentheses. Example: 'I ___ (have lived) here for five years.'",
                type: "fill-in-the-blanks"
            },
            {
                name: "Prepositions of Place",
                explanationPrompt: "Explain common prepositions of place (e.g., in, on, at, under, over, next to, between, behind, in front of) in English for adult ESL learners. Provide clear definitions and example sentences for each.",
                exercisePrompt: "Generate 5 fill-in-the-blanks sentences for adult ESL learners to practice prepositions of place. For each sentence, provide the correct preposition in the parentheses. Example: 'The book is ___ (on) the table.'",
                type: "fill-in-the-blanks"
            },
            {
                name: "Articles (a, an, the)",
                explanationPrompt: "Explain the use of definite and indefinite articles (a, an, the) in English for adult ESL learners. Cover when to use 'a', 'an', 'the', and when to use no article. Provide clear examples for each rule.",
                exercisePrompt: "Generate 5 fill-in-the-blanks sentences for adult ESL learners to practice articles (a, an, the, or no article). For each sentence, provide the correct article in the parentheses. Example: 'She bought ___ (a) new car.' or 'I love ___ (the) sun.' or 'I like ___ (no article) coffee.'",
                type: "fill-in-the-blanks"
            }
        ];

        let currentTopicIndex = 0;
        let currentExerciseData = []; // Stores parsed exercise data (sentence parts, correct answer)
        let currentExerciseIndex = 0;

        // DOM Elements
        const topicSelect = document.getElementById('topic-select');
        const explanationSection = document.getElementById('explanation-section');
        const explanationTopicTitle = document.getElementById('explanation-topic-title');
        const grammarExplanationDiv = document.getElementById('grammar-explanation');
        const startExerciseBtn = document.getElementById('start-exercise-btn');
        const exerciseSection = document.getElementById('exercise-section');
        const exerciseTopicTitle = document.getElementById('exercise-topic-title');
        const exerciseContentDiv = document.getElementById('exercise-content');
        const exerciseInputArea = document.getElementById('exercise-input-area');
        const feedbackDiv = document.getElementById('feedback');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextExerciseBtn = document.getElementById('next-exercise-btn');
        const backToTopicsBtn = document.getElementById('back-to-topics-btn');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Function to show/hide loading indicator
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Function to call Gemini API
        async function callGeminiAPI(prompt) {
            showLoading(true);
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorBody)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Unexpected API response structure or no content.');
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                await showMessageBox("Failed to load content. Please try again later.");
                return null;
            } finally {
                showLoading(false);
            }
        }

        // Display Grammar Explanation
        async function displayGrammarExplanation(topicIndex) {
            currentTopicIndex = topicIndex;
            const topic = grammarTopics[currentTopicIndex];
            explanationTopicTitle.textContent = topic.name;
            exerciseTopicTitle.textContent = topic.name; // Set for exercise section too

            explanationSection.classList.remove('hidden');
            exerciseSection.classList.add('hidden');
            feedbackDiv.textContent = ''; // Clear previous feedback

            const explanationText = await callGeminiAPI(topic.explanationPrompt);
            if (explanationText) {
                grammarExplanationDiv.innerHTML = formatMarkdownToHtml(explanationText);
            } else {
                grammarExplanationDiv.textContent = "Failed to load explanation.";
            }
        }

        // Generate and Display Exercise
        async function generateExercise(topicIndex) {
            const topic = grammarTopics[topicIndex];
            const exerciseText = await callGeminiAPI(topic.exercisePrompt);

            if (exerciseText) {
                currentExerciseData = parseFillInTheBlanks(exerciseText);
                if (currentExerciseData.length > 0) {
                    currentExerciseIndex = 0;
                    displayCurrentExercise();
                    explanationSection.classList.add('hidden');
                    exerciseSection.classList.remove('hidden');
                    checkAnswerBtn.classList.remove('hidden');
                    nextExerciseBtn.classList.add('hidden');
                    backToTopicsBtn.classList.add('hidden');
                    feedbackDiv.textContent = '';
                } else {
                    await showMessageBox("Failed to generate valid exercises. Please try another topic.");
                    displayGrammarExplanation(currentTopicIndex); // Go back to explanation
                }
            } else {
                await showMessageBox("Failed to generate exercises.");
                displayGrammarExplanation(currentTopicIndex); // Go back to explanation
            }
        }

        // Parse fill-in-the-blanks exercises from LLM output
        function parseFillInTheBlanks(text) {
            const exercises = [];
            const lines = text.split('\n').filter(line => line.trim() !== '');

            lines.forEach(line => {
                // Modified regex to be more flexible, matching different types of parentheses or formatting
                const match = line.match(/^(.*?)\s*___\s*\(?([^)]*)\)?\s*(.*)$/);
                if (match) {
                    const [, beforeBlank, correctAnswer, afterBlank] = match;
                    exercises.push({
                        before: beforeBlank.trim(),
                        answer: correctAnswer.trim(),
                        after: afterBlank.trim()
                    });
                }
            });
            return exercises;
        }

        // Display the current exercise
        function displayCurrentExercise() {
            if (currentExerciseData.length === 0) {
                exerciseContentDiv.textContent = "No exercises available.";
                exerciseInputArea.innerHTML = '';
                return;
            }

            const exercise = currentExerciseData[currentExerciseIndex];
            exerciseContentDiv.innerHTML = `
                <p>${currentExerciseIndex + 1}. ${exercise.before} <span id="blank-placeholder">_____</span> ${exercise.after}</p>
            `;
            exerciseInputArea.innerHTML = `
                <input type="text" id="user-answer" class="input-field mt-2" placeholder="Type your answer here">
            `;
            document.getElementById('user-answer').focus();
        }

        // Check user's answer
        function checkAnswer() {
            const userAnswerInput = document.getElementById('user-answer');
            if (!userAnswerInput) return;

            const userAnswer = userAnswerInput.value.trim().toLowerCase();
            const correctAnswer = currentExerciseData[currentExerciseIndex].answer.toLowerCase();
            const blankPlaceholder = document.getElementById('blank-placeholder');

            if (userAnswer === correctAnswer) {
                feedbackDiv.textContent = "Correct!";
                feedbackDiv.className = 'feedback-correct text-lg font-semibold mb-4';
                blankPlaceholder.textContent = correctAnswer; // Show correct answer in place
                userAnswerInput.disabled = true; // Disable input after correct answer
                checkAnswerBtn.classList.add('hidden');
                nextExerciseBtn.classList.remove('hidden');
                backToTopicsBtn.classList.remove('hidden');
            } else {
                feedbackDiv.textContent = `Incorrect. The correct answer is "${currentExerciseData[currentExerciseIndex].answer}".`;
                feedbackDiv.className = 'feedback-incorrect text-lg font-semibold mb-4';
                // Allow user to try again or move on
                checkAnswerBtn.classList.add('hidden');
                nextExerciseBtn.classList.remove('hidden');
                backToTopicsBtn.classList.remove('hidden');
            }
        }

        // Move to the next exercise or finish
        function nextExercise() {
            currentExerciseIndex++;
            feedbackDiv.textContent = ''; // Clear feedback
            if (currentExerciseIndex < currentExerciseData.length) {
                displayCurrentExercise();
                checkAnswerBtn.classList.remove('hidden');
                nextExerciseBtn.classList.add('hidden');
                backToTopicsBtn.classList.add('hidden');
            } else {
                showMessageBox("You have completed all exercises for this topic! Well done!");
                displayGrammarExplanation(currentTopicIndex); // Go back to explanation or topic selection
            }
        }

        // Format Markdown to HTML (simple version)
        function formatMarkdownToHtml(markdownText) {
            let html = markdownText;

            // Convert bold (**text** or __text__)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');

            // Convert italics (*text* or _text_)
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');

            // Convert headers (## Header)
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Convert unordered lists (- item or * item)
            html = html.replace(/^\s*[\-\*]\s*(.*)$/gim, '<li>$1</li>');
            if (html.includes('<li>')) {
                html = '<ul>' + html + '</ul>';
            }

            // Convert ordered lists (1. item)
            html = html.replace(/^\s*\d+\.\s*(.*)$/gim, '<li>$1</li>');
            if (html.includes('<li>') && !html.includes('<ul>')) { // Check if not already wrapped in ul
                html = '<ol>' + html + '</ol>';
            }

            // Convert code blocks (```language\ncode\n```)
            html = html.replace(/```(.*?)?\n([\s\S]*?)```/g, '<pre class="bg-gray-100 p-3 rounded-md overflow-x-auto my-4"><code>$2</code></pre>');

            // Convert inline code (`code`)
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');

            // Convert newlines to paragraphs (basic, assumes double newline for new paragraph)
            html = html.split('\n\n').map(p => `<p>${p.trim()}</p>`).join('');
            html = html.replace(/<p><\/p>/g, ''); // Remove empty paragraphs

            return html;
        }

        // Event Listeners
        topicSelect.addEventListener('change', (event) => {
            displayGrammarExplanation(parseInt(event.target.value));
        });

        startExerciseBtn.addEventListener('click', () => {
            generateExercise(currentTopicIndex);
        });

        checkAnswerBtn.addEventListener('click', checkAnswer);

        nextExerciseBtn.addEventListener('click', nextExercise);

        backToTopicsBtn.addEventListener('click', () => {
            explanationSection.classList.add('hidden');
            exerciseSection.classList.add('hidden');
            feedbackDiv.textContent = '';
            topicSelect.value = currentTopicIndex; // Keep current topic selected
            // Optionally, reload explanation for the current topic
            displayGrammarExplanation(currentTopicIndex);
        });

        // Initialize the app
        window.onload = function() {
            // Populate topic dropdown
            grammarTopics.forEach((topic, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = topic.name;
                topicSelect.appendChild(option);
            });

            // Display the first topic's explanation by default
            if (grammarTopics.length > 0) {
                displayGrammarExplanation(0);
            } else {
                showMessageBox("No grammar topics configured. Please add topics to the app.");
            }
        };

    </script>
</body>
</html>
